#define NULLDC_HACK
#undef EFFECT_CREDITS
//#define ENABLE_VIDEO_SMPEG

#define RINGBUF_AUDIO

#define VIDEOMODE_FLAGS (SDL_HWSURFACE | SDL_FULLSCREEN)
//#define VIDEOMODE_FLAGS (SDL_SWSURFACE | SDL_DOUBLEBUF | SDL_FULLSCREEN)
//#define VIDEOMODE_FLAGS (SDL_HWSURFACE | SDL_DOUBLEBUF | SDL_FULLSCREEN)
//#define VIDEOMODE_FLAGS (SDL_SWSURFACE | SDL_DOUBLEBUF | SDL_FULLSCREEN)
//#define VIDEOMODE_BITS 16
#define VIDEOMODE_BITS 32

//#define FILTER_HACK

#define VIDEOMODE_16BITS_TEMP_HACK

#define FILE_PREFIX "/cd/"
//#define FBUFFER_FULL_UPDATE

#undef CHECK_FILESYSTEM
#define DISABLE_MIDI

#undef SCREEN_WIDTH 
#undef SCREEN_HEIGHT
#define SCREEN_WIDTH  640
#define SCREEN_HEIGHT 480

#undef IMAGE_CACHE_MAX_DEFAULT

#ifdef FILTER_HACK
#define IMAGE_CACHE_MAX_DEFAULT 4
#else
#define IMAGE_CACHE_MAX_DEFAULT 6
#endif

#undef SAVE_FULL
#define SAVE_FULL 0

#include <dc/maple/vmu.h>
#include <malloc.h>

void message(char *format, ...) { }

unsigned short vmu_icon1_pal[] = {0xF000, 0xF765, 0xF554, 0xF333, 0xF111, 0xFA98, 0xF766, 0xF99A, 0xF888, 0xF667, 0xF366, 0xFABB, 0xF489, 0xF876, 0xF000, 0xF000, };

unsigned char vmu_icon1_img[] = {
	0x23,0x32,0x32,0x22,0x22,0x21,0x22,0x22,0x21,0x21,0x66,0x66,0x61,0x32,0x21,0x21,
	0x23,0x33,0x22,0x22,0x22,0x11,0x62,0x23,0x22,0x11,0x61,0x11,0x11,0x23,0x22,0x12,
	0x23,0x32,0x22,0x22,0x22,0x11,0x16,0x22,0x32,0x22,0x11,0x11,0x16,0x22,0x32,0x21,
	0x23,0x22,0x22,0x22,0x11,0x11,0x11,0x12,0x23,0x22,0x11,0x11,0x11,0x62,0x23,0xA2,
	0x23,0x22,0x32,0x22,0x21,0x22,0x33,0x43,0x44,0x43,0x31,0x11,0x11,0x11,0x23,0x31,
	0x23,0x22,0x22,0x22,0x12,0x34,0x00,0x00,0x00,0x00,0x44,0x21,0x61,0x11,0x13,0x22,
	0x22,0x32,0x32,0x22,0x40,0x00,0x43,0x33,0x33,0x40,0x00,0x04,0x26,0x11,0x11,0x32,
	0x23,0x22,0x22,0x30,0x04,0xA2,0xA3,0x33,0xA2,0x93,0x40,0x00,0x43,0x61,0x11,0x22,
	0x32,0x32,0x34,0x04,0x29,0x34,0x00,0x00,0x00,0x03,0x33,0x00,0x00,0x31,0x11,0x12,
	0x33,0x23,0x40,0x39,0x90,0x00,0x00,0x00,0x44,0x34,0x44,0xA4,0x00,0x03,0x61,0x11,
	0x32,0x34,0x02,0xC9,0x00,0x00,0x04,0x04,0x39,0x88,0x30,0x49,0x40,0x00,0x36,0x16,
	0x23,0x40,0x28,0x84,0x00,0x00,0x44,0x44,0xA8,0xBB,0x84,0x02,0x84,0x00,0x41,0x66,
	0x24,0x03,0x98,0x20,0x00,0x04,0x04,0x04,0x38,0x7B,0x94,0x03,0x91,0x00,0x03,0x16,
	0x14,0x4A,0x89,0x30,0x00,0x34,0x40,0x40,0x39,0x78,0x90,0x00,0x57,0x20,0x00,0x16,
	0x23,0x49,0x88,0x40,0x04,0x44,0x00,0x00,0x03,0x32,0x34,0x00,0x8B,0x84,0x00,0x46,
	0x14,0x21,0x77,0x40,0x43,0x34,0x40,0x40,0x40,0x33,0x34,0x00,0x6B,0xB2,0x00,0x36,
	0x22,0x88,0x88,0x00,0x03,0x34,0x00,0x00,0x00,0x43,0x44,0x00,0x9B,0xB8,0x00,0x25,
	0x19,0x78,0x78,0x40,0x4A,0xA4,0x00,0x00,0x00,0x33,0x30,0x00,0x8B,0xB8,0x04,0xD5,
	0x66,0x87,0x77,0x00,0x4A,0xA3,0x00,0x00,0x04,0x3A,0x44,0x00,0x7B,0xB9,0x02,0x55,
	0xD1,0x87,0x77,0x30,0x4A,0xC9,0x93,0x00,0x43,0xAA,0xA0,0x04,0xB7,0xB3,0x45,0x55,
	0x61,0x67,0x87,0x20,0x03,0xCB,0x7A,0x33,0x3A,0xAA,0x40,0x02,0x77,0x83,0x65,0x55,
	0x61,0x18,0x77,0x74,0x04,0x8B,0xBC,0xCC,0xCC,0xC3,0x40,0x49,0x77,0x92,0x55,0x55,
	0x61,0x11,0x87,0x79,0x03,0xA9,0xAC,0xCC,0xCA,0x30,0x00,0x37,0x77,0x25,0x55,0x55,
	0xD1,0x11,0x19,0x77,0x93,0x34,0x44,0x33,0x34,0x00,0x03,0x77,0x7D,0x55,0x55,0x55,
	0x61,0x11,0x11,0x28,0x79,0x40,0x00,0x00,0x00,0x00,0x37,0x79,0x2D,0x55,0x55,0x55,
	0x61,0x11,0x11,0x13,0xA8,0x82,0x30,0x40,0x00,0x39,0x79,0x23,0x65,0x55,0x55,0x55,
	0x61,0x11,0x11,0x11,0x33,0x39,0x88,0x99,0x98,0x91,0x44,0x31,0x85,0x55,0x55,0x55,
	0xD1,0x11,0x11,0x11,0x62,0x34,0x44,0x33,0x34,0x44,0x32,0x6D,0xB5,0x55,0x55,0x55,
	0x61,0x11,0x11,0x11,0x16,0x11,0x33,0x43,0x43,0x21,0x11,0x65,0x55,0x55,0x55,0x55,
	0x61,0x11,0x11,0x11,0x11,0x11,0x66,0x66,0x61,0x61,0x11,0xD5,0x55,0x55,0x55,0x55,
	0x61,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0xD5,0x55,0x55,0x55,0x55,
	0xD6,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x55,0xB5,0x55,0xB5,0x55,
};

unsigned short vmu_icon2_pal[] = {0xF000, 0xFFFF, 0xF666, 0xF223, 0xF445, 0xF334, 0xF111, 0xF779, 0xF458, 0xF024, 0xF246, 0xF57B, 0xF569, 0xFACF, 0xF89C, 0xFFFF, };

unsigned char vmu_icon2_img[] = {
	0xAA,0xAA,0xAA,0xAA,0xAA,0xA3,0x36,0x63,0x33,0x33,0x66,0x66,0x5D,0xDD,0x83,0x33,
	0xAA,0xAA,0xAA,0xA9,0x66,0x00,0x66,0x63,0x36,0x66,0x63,0x53,0x9E,0xEE,0xE5,0x35,
	0xAA,0xAA,0x96,0x00,0x66,0x63,0x63,0x55,0x35,0x53,0x34,0x44,0x58,0xDB,0xDB,0x54,
	0xAA,0x96,0x00,0x65,0x53,0x33,0x32,0x44,0x44,0x54,0x55,0x45,0x33,0xED,0xDB,0x32,
	0x90,0x00,0x06,0x44,0x53,0x33,0x22,0x22,0x24,0x22,0x45,0x45,0x44,0xB1,0xD2,0x42,
	0x60,0x00,0x65,0x43,0x35,0x32,0x77,0x22,0x22,0x72,0x42,0x42,0x44,0x2D,0xB4,0xC7,
	0x60,0x00,0x34,0x35,0x45,0x52,0x77,0x42,0x42,0x24,0x27,0x22,0x22,0x2D,0xB4,0xC7,
	0x60,0x06,0x53,0x32,0x55,0x47,0x24,0x24,0x42,0x44,0x27,0x27,0x22,0x7D,0xEA,0x8E,
	0x60,0x03,0x33,0x43,0x53,0x22,0x44,0x55,0x42,0x52,0x72,0x27,0x27,0x7D,0xD8,0xCB,
	0x60,0x65,0x35,0x53,0x53,0x42,0x54,0x54,0x54,0x52,0x74,0x27,0x77,0xED,0x1B,0xBB,
	0x60,0x63,0x35,0x33,0x35,0x44,0x55,0x55,0x45,0x52,0x75,0x27,0x77,0xED,0x1D,0xBE,
	0x60,0x33,0x35,0x33,0x33,0x45,0x53,0x53,0x45,0x42,0x24,0x27,0x7E,0xE1,0x1E,0xBE,
	0x60,0x36,0x53,0x63,0x63,0x45,0x35,0x35,0x25,0x42,0x75,0x8E,0xEE,0xDD,0x1E,0xBE,
	0x60,0x33,0x33,0x33,0x33,0x45,0x35,0x35,0x45,0x42,0x7A,0x87,0x7E,0xDD,0xDD,0xBD,
	0x66,0x36,0x33,0x53,0x55,0x53,0x35,0x55,0x85,0x44,0x74,0x8E,0xBE,0xDD,0xED,0xED,
	0x60,0x66,0x36,0x53,0x53,0x53,0x85,0x85,0x44,0xA4,0xCA,0x8E,0x7B,0xDE,0xBD,0xDE,
	0x60,0x66,0x33,0x59,0x54,0x94,0x23,0x24,0x48,0x44,0xC4,0x87,0xBE,0xDB,0xED,0x1D,
	0x60,0x66,0x39,0x33,0x6A,0x48,0x25,0xA4,0x52,0x84,0x88,0x8B,0xCB,0xDB,0xEE,0xDD,
	0x66,0x66,0x93,0xA8,0x95,0x4C,0xC4,0x24,0xA4,0x85,0x88,0x8B,0xBB,0xDE,0xEE,0xDD,
	0x66,0x66,0x69,0x4A,0x5A,0xCC,0xCC,0xC9,0x63,0x24,0x58,0x8B,0xBB,0xDD,0xBD,0xDE,
	0x66,0x66,0x99,0x8C,0xCC,0xCC,0xCC,0x74,0x3A,0x6A,0xA8,0xCB,0xCB,0xED,0xDD,0xDD,
	0x96,0x96,0x69,0x8C,0xC8,0x77,0xCC,0x85,0x55,0x84,0xA8,0x8B,0xCB,0xBE,0xDD,0xDD,
	0x96,0x69,0x99,0x8C,0x88,0xC7,0xCC,0xCE,0x77,0xEC,0x44,0xCB,0x8B,0xBB,0xDD,0xDD,
	0x99,0x99,0x96,0xA8,0x88,0xCC,0xCC,0xC7,0xEE,0xEC,0xA8,0xCC,0x8B,0xBE,0xDD,0xDD,
	0x99,0x99,0x99,0xA8,0x88,0x8C,0xCC,0xC7,0xEE,0xE2,0x78,0xCC,0x88,0xBE,0xDD,0xDE,
	0x99,0x99,0x99,0xA8,0x88,0xCC,0xCC,0xC7,0xEE,0x77,0x78,0xCC,0x88,0xBB,0xED,0xBE,
	0x99,0x99,0x99,0xAA,0x88,0xCC,0xCC,0x7E,0xEE,0xEE,0xC8,0xC8,0x8A,0xB8,0xBD,0xBE,
	0x99,0x99,0x9A,0xA9,0xAC,0xCC,0xBC,0x7D,0xEE,0x7C,0x72,0x88,0x8A,0x88,0xBE,0xEB,
	0x99,0x99,0x9A,0xAA,0x8C,0xBC,0xCE,0xE7,0x77,0x2C,0x28,0x4A,0x8A,0x88,0xBB,0xEB,
	0xA9,0x99,0x9A,0xAA,0xBB,0xC8,0x88,0x28,0x22,0xC7,0x8C,0x58,0x88,0x8A,0x8B,0xDB,
	0x99,0xA9,0xAA,0x98,0x7B,0xB8,0x85,0x8C,0xCC,0x7E,0xC2,0x94,0x88,0xA8,0xAB,0xEE,
	0xAA,0xAA,0xA8,0xAC,0xEB,0xCC,0xC8,0x87,0x77,0xE7,0x23,0x54,0x42,0xA8,0x88,0xBD,
};



/*void message_info(char *format, ...) {
	char buffer[0x1000];
	va_list ap;
	va_start(ap, format);
	vsprintf(buffer, format, ap);
	//pspDebugScreenSetXY(0, 0);
	//pspDebugScreenPrintf("%s", buffer);
	
	{
		SDL_Surface *surface;
		surface = TTF_RenderText_Shaded(font, buffer, white, black);
		SDL_BlitSurface(surface, NULL, screen_video, NULL);
		SDL_UpdateRect(screen_video, 0, 0, surface->w, surface->h);
		SDL_FreeSurface(surface);
	}
	
	va_end(ap);
}*/

int dc_save_file_save(int type, int n, char *data, int data_length) {
    vmu_pkg_t pkg;
    uint8 *pkg_out;
    int pkg_size;
	char name[0x10];
	file_t f;
	
	ZERO(pkg);

	pkg.icon_cnt = 1;

	if (type == 0) {
		sprintf(pkg.desc_short, "System");
		sprintf(pkg.desc_long, "System Save");
		sprintf(pkg.app_id, "DiviDead");
		sprintf(name, "/vmu/A1/divi");
		
	    pkg.icon_data = vmu_icon2_img;
	    memcpy(pkg.icon_pal, vmu_icon2_pal, 32);
	} else {
		sprintf(pkg.desc_short, "Save %d", n);
		//sprintf(pkg.desc_long, "File Save %d", n);
		sprintf(pkg.desc_long, "%s", save_s.names[n]);
		
		printf("dc_save_file_save|desc_long:: %s\n", save_s.names[n]);
		
		sprintf(pkg.app_id, "DiviDead");
		sprintf(name, "/vmu/A1/divi%d", n);
		
	    pkg.icon_data = vmu_icon1_img;
	    memcpy(pkg.icon_pal, vmu_icon1_pal, 32);
	}

    pkg.icon_anim_speed = 0;
    pkg.eyecatch_type = VMUPKG_EC_NONE;
    pkg.data = data;
    pkg.data_len = data_length;	
	
    if (vmu_pkg_build(&pkg, &pkg_out, &pkg_size) < 0) {
		printf("Error vmu_pkg_build()\n");
		return -1;
	}

	if ((f = fs_open(name, O_WRONLY | O_TRUNC)) == -1) {
		printf("Can't write VMU ('%s')\n", name);
		return -2;
	}
	
	printf("Writting ('%s')\n", name);
	fs_write(f, pkg_out, pkg_size);
	fs_close(f);
	
	return 0;
}

int dc_save_file_load(int type, int n, char *data, int *data_length) {
	file_t inf;
	vmu_pkg_t pkg;
	char name[0x10];
	char *map;
	
	if (type == 0) {
		sprintf(name, "/vmu/A1/divi");
	} else {
		sprintf(name, "/vmu/A1/divi%d", n);
	}	

    if ((inf = fs_open(name, O_RDONLY)) == -1) {
        printf("Can't read VMU ('%s')\n", name);
        return - 1;
    }
	
	printf("Readed VMU ('%s')\n", name);
	
	if (!(map = fs_mmap(inf))) {
		printf("Error fs_mmap()\n");
		return -2;
	}

	if (vmu_pkg_parse(map, &pkg) == -1) {
		printf("Error vmu_pkg_parse()\n");
		return -3;
	}

	memcpy(data, pkg.data, pkg.data_len);
	*data_length = pkg.data_len;
	
	fs_close(inf);
	
	return 0;
}

void dc_sys_hack() {
	file_t inf;
	int n, m;
	char *map = NULL;
	char name[0x10];
	char desc_long[0x40];
	vmu_pkg_t pkg;
	ZERO(pkg);
	printf("dc_sys_hack():");
	for (n = 0; n < 10; n++) {
		sprintf(name, "/vmu/A1/divi%d", n);
		printf("%d", n);
		
		if ((inf = fs_open(name, O_RDONLY)) == -1) {
			printf(".");
			sprintf(save_s.names[n], lang_texts[11]);
			continue;
		}		
		
		map = fs_mmap(inf);
		if (!map) {
			printf("-");
			continue;
		}
		printf("*");
		vmu_pkg_parse(map, &pkg);
		memcpy(desc_long, pkg.desc_long, sizeof(pkg.desc_long));
		desc_long[sizeof(pkg.desc_long)] = 0;
		for (m = sizeof(pkg.desc_long) - 1; m > 0; m--) {
			if (desc_long[m] == ' ') continue;
			if (desc_long[m] == '\0') continue;
			break;
		}
		desc_long[m + 1] = 0;
		sprintf(save_s.names[n], "%s", desc_long);
	}
	printf("\n");
}

int dc_draw_vmu_icon_block = 0;

void dc_draw_vmu_icon(char *icon, int count_images) {
	char temp[192] = {0};
	maple_device_t *dev;
	int i = 0;
	int x, y, n;
	
	if (dc_draw_vmu_icon_block) return;
	
	if (icon == NULL) icon = temp;
	
	while ((dev = maple_enum_type(i++, MAPLE_FUNC_LCD))) {
		vmu_draw_lcd(dev, icon);
	}

	if (0) {
		printf("dc_draw_vmu_icon {\n");
		for (y = 0, i = 0; y < 32; y++) {
			printf("  '");
			for (x = 0; x < 48; x += 8, i++) {
				for (n = 0; n < 8; n++) {
					printf("%c", ((icon[i] >> (7 - n)) & 1) ? '.' : '*');
				}
			}
			printf("'\n");
		}
		printf("}\n");
	}
}


int ask(char *text, int _default) {
	return _default;
}

void DC_MEMORY_DEBUG() {
	struct mallinfo mi = mallinfo();
	printf("\n");
	printf("DC_MEMORY_DEBUG() mallinfo {\n");
	printf("   arena:    %d\n", mi.arena);
	printf("   ordblks:  %d\n", mi.ordblks);
	printf("   smblks:   %d\n", mi.smblks);
	printf("   hblks:    %d\n", mi.hblks);
	printf("   hblkhd:   %d\n", mi.hblkhd);
	printf("   usmblks:  %d\n", mi.usmblks);
	printf("   fsmblks:  %d\n", mi.fsmblks);
	printf("   uordblks: %d\n", mi.uordblks);
	printf("   fordblks: %d\n", mi.fordblks);
	printf("   keepcost: %d\n", mi.keepcost);
	printf("}\n");
	printf("\n");
}

void DC_MEMORY_DEBUG2() {
	printf("\n");
	printf("DC_MEMORY_DEBUG() malloc_stats {\n");
	malloc_stats();
	printf("}\n");
	printf("\n");
}

char* dc_langs[] = {
	"JAPANESE",
	"ENGLISH",
	"GERMAN",
	"FRENCH",
	"SPANISH",
	"ITALIAN",
};

void preinit() {
	flashrom_syscfg_t cfg;
	flashrom_get_syscfg(&cfg);
	strcpy(language, dc_langs[cfg.language % (sizeof(dc_langs) / sizeof(dc_langs[0]))]);
	printf("DC_LANG(%d): %s\n", cfg.language, language);
}

#undef MEMORY_DEBUG
#undef MEMORY_DEBUG2
#define MEMORY_DEBUG() DC_MEMORY_DEBUG();
#define MEMORY_DEBUG2() DC_MEMORY_DEBUG2();
